<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
    <link rel="stylesheet" href="assets/style.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">
    <title>Editar pregunta</title>
</head>

<body>
    <a class="button is-dark is-small" href="../menu/index.html">
        <span class="icon">
            <i class="fas fa-home"></i>
        </span>
        <span>MENU</span>
    </a>
    <div class="card">
        <div class="card-content">
            <h1 class="title is-2 has-text-centered">Escribe la pregunta que deseas editar</h1>
            <div class="field">
                <label class="label">Pregunta:</label>
                <div class="control">
                    <input class="input" type="text" id="pregunta_a_modificar" required placeholder="Tu pregunta..." />
                </div>
            </div>
            <button class="button is-primary" id="boton_preg">Editar</button>
            <button class="button is-primary" id="boton_borrar">Borrar</button>
            
            <div class="notification is-warning is-light" id="mensaje_buscar">
                No se encontró la pregunta.
            </div>
        </div>
    </div>
    <div class="box" >
        <div class="Gracias">
            <h1 class="title is-2 has-text-centered">Modifica tu pregunta</h1>
            <p class="subtitle is-">Completa los siguientes campos para que tu pregunta esté disponible para todos los jugadores</p>
        </div>
        <div class="field" >
            <label class="label">Pregunta:</label>
            <div class="control">
                <input class="input" type="text" id="pregunta" required placeholder="Tu pregunta..." />
            </div>
        </div>

        <div class="field has-addions" >
          <div class="control">
            <span class="select" id="selector_categoria">
              <select>
                <option> Categoria </option>
                <option> Deportes </option>
                <option> Mundi </option>
                <option> Cine </option>
                <option> Mega-Mix </option>
              </select>
            </span>
          </div>
        </div>

        <div class="field has-addions" >
          <div class="control">
            <span class="select" id="selector_dificultad">
              <select>
                <option> Dificultad </option>
                <option> Facil </option>
                <option> Intermedio </option>
                <option> Dificl </option>
              </select>
            </span>
          </div>
        </div>

        <div class="field ">
            <label class="label">Opción 1 (Correcta):</label>
            <div class="control">
                <input class="input" type="text" id="respuesta_correcta" required placeholder="A" />
            </div>
        </div>

        <div class="field">
            <label class="label">Opción 2:</label>
            <div class="control">
                <input class="input" type="text" id="respuesta_a"required placeholder="B" />
            </div>
        </div>

        <div class="field">
            <label class="label">Opción 3:</label>
            <div class="control">
                <input class="input" type="text" id="respuesta_b" required placeholder="C" />
            </div>
        </div>

        <div class="field">
            <label class="label">Opción 4</label>
            <div class="control">
                <input class="input" type="text" id="respuesta_c" required placeholder="D" />
            </div>
        </div>

        <div class="notification is-warning is-light" id="mensaje_completar_datos">
            Por favor, ingrese todos los datos.
        </div>
        <button class="button is-primary" id="boton_envio">Guardar pregunta</button>
    </div>

    <script>
        // Variables de referencia a los elementos del html
        const preguntaInput = document.getElementById("pregunta_a_modificar");
        const mensaje=document.getElementById("mensaje_completar_datos");
        const msg = document.getElementById("mensaje_buscar");
        const caja = document.querySelector(".box");
        const cajaPregunta = document.querySelector(".card");
        let preguntaId;
        const usuarioGuardado = JSON.parse(localStorage.getItem("usuario"));
      
        caja.style.display="none";
        mensaje.style.display="none";
        msg.style.display="none";

        document.getElementById("boton_preg").addEventListener("click", async function() {
            const pregunta = preguntaInput.value.trim();
            if (!pregunta) {
                msg.style.display = "block";
                msg.style.marginTop = "10px";
                setTimeout(() => {
                    msg.style.display = "none";
                }, 3000);
                return;
            }

            try {

                const res = await fetch(`http://localhost:3030/preguntas/${encodeURIComponent(usuarioGuardado[0].id)}`);

               
                  
                if (!res.ok) {
                    throw new Error("Error al obtener las preguntas");
                }
                let preguntas = await res.json();

                console.log(preguntas);

                

                preguntaId = preguntaEncontrada.id;
                document.getElementById("pregunta").value = preguntaEncontrada.pregunta;
                document.querySelector("#selector_categoria select").value = preguntaEncontrada.categoria;
                document.querySelector("#selector_dificultad select").value = preguntaEncontrada.dificultad;
                document.getElementById("respuesta_correcta").value = preguntaEncontrada.respuesta_correcta;
                document.getElementById("respuesta_a").value = preguntaEncontrada.respuesta_a;
                document.getElementById("respuesta_b").value = preguntaEncontrada.respuesta_b;
                document.getElementById("respuesta_c").value = preguntaEncontrada.respuesta_c;

                cajaPregunta.style.display = "none";
                caja.style.display = "block";

            } catch (error) {
                msg.style.display = "block";
                console.error("Error al buscar la pregunta:", error);
            }
        });

        document.getElementById("boton_borrar").addEventListener("click", async function(){
            const pregunta = preguntaInput.value.trim();
            if (!pregunta) {
                msg.style.display = "block";
                msg.style.marginTop = "10px";
                setTimeout(() => {
                    msg.style.display = "none";
                }, 3000);
                return;
            }

            try {
                const res = await fetch(`http://localhost:3030/api/preguntas/`);
                if (!res.ok) {
                    throw new Error("Error al obtener las preguntas");
                }
                let preguntas = await res.json();
                const userId = usuarioGuardado.id;

                preguntas = preguntas.filter(p => p.id_usuario === userId);
                if (preguntas.length === 0) {
                    msg.style.display = "block";
                    msg.style.marginTop = "10px";
                    setTimeout(() => {
                        msg.style.display = "none";
                    }, 3000);
                    return;
                }
                const preguntaEncontrada = preguntas.find(p => p.pregunta === pregunta);
                if (!preguntaEncontrada) {
                    msg.style.display = "block";
                    msg.style.marginTop = "10px";
                    setTimeout(() => {
                        msg.style.display = "none";
                    }, 3000);
                    return;
                }

                preguntaId = preguntaEncontrada.id;

                const confirmar = confirm("¿Estás seguro que deseas eliminar la pregunta?"); 
                if (!confirmar) {
                    return;
                }
                const response = await fetch(`http://localhost:3030/api/preguntas/${preguntaId}`, {
                    method: "DELETE"
                });

                if (response.ok) {
                    alert("Pregunta eliminada correctamente");
                    cajaPregunta.style.display = "block";
                    caja.style.display = "none";
                    preguntaInput.value = "";
                    preguntaId = null;
                } else {
                    alert("No se pudo eliminar la pregunta");
                }

            } catch (error) {
                alert("Error al eliminar la pregunta");
                console.error(error);
            }
        })

        document.getElementById("boton_envio").addEventListener("click", async function() {

        const pregunta = document.getElementById("pregunta").value.trim();
        const categoria = document.querySelector("#selector_categoria select").value.trim();
        const dificultad= document.querySelector("#selector_dificultad select").value.trim();
        const respuesta_correcta = document.getElementById("respuesta_correcta").value.trim();
        const respuesta_a = document.getElementById("respuesta_a").value.trim();
        const respuesta_b = document.getElementById("respuesta_b").value.trim();
        const respuesta_c = document.getElementById("respuesta_c").value.trim();

        if(!pregunta || categoria === "Categoria" || dificultad === "Dificultad" || !respuesta_correcta || !respuesta_a || !respuesta_b || !respuesta_c ){
            mensaje.style.display="block";
            mensaje.style.marginTop = "10px";
                setTimeout(() => {
                    mensaje.style.display = "none";
                }, 3000);
            return;
        }

        let puntos = 0;
        
        if(dificultad === "Facil"){
            puntos =10;
        }
        else {
            if(dificultad === "Intermedio" ){
                puntos = 20;
            }
            else{
                puntos = 30;
            }
        }
            try{
                const response= await fetch(`http://localhost:3030/api/preguntas/${preguntaId}`,{

                    method: "PUT",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        pregunta: pregunta,
                        categoria: categoria,
                        dificultad: dificultad,
                        puntos: puntos,
                        respuesta_a: respuesta_a,
                        respuesta_b: respuesta_b,
                        respuesta_c: respuesta_c,
                        respuesta_correcta: respuesta_correcta
                    })
                })
                if (response.ok){
                    alert("¡Pregunta editada con éxito!");
                    document.getElementById("pregunta").value = "";
                    document.querySelector("#selector_categoria select").value = "Categoria";
                    document.querySelector("#selector_dificultad select").value = "Dificultad";
                    document.getElementById("respuesta_correcta").value = "";
                    document.getElementById("respuesta_a").value = "";
                    document.getElementById("respuesta_b").value = "";
                    document.getElementById("respuesta_c").value = "";
                    caja.style.display = "none";
                    cajaPregunta.style.display = "block";
                    preguntaInput.value = "";
                    preguntaId = null;
                    mensaje.style.display = "none";
                }else{
                    alert("No se pudo editar la pregunta");
                }
               
            }catch(error){
                alert("Error al editar la pregunta");
                console.error(error);
            }
        });
    </script>