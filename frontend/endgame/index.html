<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@1.0.4/css/bulma.min.css">
	<link rel="stylesheet" href="assets/style_endgame.css">
	<title>Fin de Partida</title>
</head>

<body>
	<div class="container" id="data">

		<div class="box" id="titulo">
			<h1 class="title">Fin de la Partida</h1>
		</div>

		<div class="informacion_partida">

			<div class="box" id="puntos">
				<h1 class="resultado"> RESULTADOS: </h1>
				<div class="box" id="puntaje">
					<h1 id="h1_puntaje">Puntos: </h1>
				</div>
				<div class="box" id="record">
					<h1 id="h1_record"> Record: </h1>
				</div>
			</div>

			<div class="box" id="ranking">
				<h1> RANKING </h1>
				<div class="image-container" id="copa">
					<img src="assets/trofeo.png" alt="Fin de Partida" class="imagen">
				</div>
				<ol class="puestos">
					<li class="p1" id="top1">Usuario1 - puntos</li>
					<li class="p2" id="top2">Usuario2 - puntos</li>
					<li class="p3" id="top3">Usuario3 - puntos</li>	
				</ol>
			</div>
		</div>
	</div>

	<div class="container has-text-centered" id="boton-container">
		<a class="button is-link" href="../menu/index.html">Volver al Men√∫</a>
	</div>
	<script>	
			const elemPuntos = document.querySelector("#h1_puntaje")
			const elemRecordPuntos = document.querySelector("#h1_record")
			const top1 = document.querySelector("#top1")
			const top2 = document.querySelector("#top2")
			const top3 = document.querySelector("#top3")

			const params = new URLSearchParams(window.location.search)
			const puntos = params.get("puntos")

            const usuarioGuardado = JSON.parse(localStorage.getItem("usuario")); 
				setTimeout(() => {
					if (usuarioGuardado == null) {
						alert("No has iniciado sesion");
						window.location.href = "../login-regis/index.html";
					}
				}, 200);
			console.log(usuarioGuardado)
			elemPuntos.innerHTML = `Puntos: <strong>${puntos}</strong>`

			async function getUsuario(id) {
				try {
					const response = await fetch(`http://localhost:3030/api/usuarios/id/${id}`)
					const usuario = await response.json()
					return usuario
				} catch (error) {
					console.error("Ocurrio un error.", error)	
					return false
				}
			}

			async function chequearRecord(puntos) {
				const usuario = await getUsuario(usuarioGuardado.id)
				if (puntos > usuario.mejor_puntaje) {
					elemRecordPuntos.innerHTML = `Record: <strong>${puntos}</strong> <span style="color: red;">Nuevo record!</span>`
					actualizarUsuario(usuario)
				} else {
					elemRecordPuntos.innerHTML = `Record: <strong>${usuario.mejor_puntaje}</strong>`
				}
			}

			async function actualizarUsuario(usuario) {
				try {
					const response = await fetch(`http://localhost:3030/api/usuarios/${usuario.id}`, {
						method: "PUT",
						headers: {
							"Content-type": "application/json"
						},
						body: JSON.stringify({
							id: usuario.id,
							usuario: usuario.usuario,
							nombre: usuario.nombre,
							edad: usuario.edad,
							url_perfil: usuario.url_perfil,
							mejor_puntaje: puntos
						})
					})
					const data = await response.json()
					console.log("Usuario editado: ", data)
					localStorage.setItem("usuario", JSON.stringify(data))
				} catch (error) {
					console.error("Error: ", error)	
				}
			}
			chequearRecord(puntos)
	</script>
</body>
</html>